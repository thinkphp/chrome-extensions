<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
   <meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
   <title>JavaScript Snake Game</title>
   <style type="text/css">
   html, body {    margin: 0;    padding: 0;    height: 450px;width: 400px}
   body {font-family: arial, helvetica, sans-serif;    font-size: 12px;    line-height: 1.2em;}
   p {margin: 0;padding: 0;}
   #container {width: 300px; height: 300px;position: absolute;left: 50%;top: 50%; margin-top: -180px;margin-left: -151px;z-index: 1;}

   #snake {clear: both;border: solid 1px #DDDDDD;}
   #snake table {}
   #snake td {width: 20px; height: 20px; background: #EEEEEE;}
   #snake td.snake-segment {background-color: green;}            
   #snake td.apple { background-color: red;}
   #snake td.dead { background-color: #666666;}

   #key-snake-segment {    color: green; }
   #key-apple {    color: red; }


   </style>
   <script type="text/javascript">
   /**
    * 
    *
    */
   var Snake = function(divId, width, height, scoreId, timeId, highScoreId, resetId, speedPrefixId) {
       var $ = function(id) {return document.getElementById(id);}
       var div = document.getElementById(divId),
           scoreField = document.getElementById(scoreId),
           timeField = document.getElementById(timeId),
           highScoreField = document.getElementById(highScoreField),
           resetButton = document.getElementById(resetId),
           speeds = [{speed: 'slow', value: 200}, {speed: 'medium', value: 150}, {speed: 'fast', value: 100}],
           table;

       var delay, 
           inGame,
           snake,
           apple,
           score,
           startTime,
           gameDuration;
    
           /* init */
           createTable();

          /* Bind the buttons speed at right click events */
          for(var i=0,j=speeds.length; i<j; i++) {
              $(speedPrefixId + speeds[i].speed).onclick = (function(i,d) {
                     return function(){
                       delay = d;
                       if(!inGame) {
                          startGame();  
                       }
                       return false;
                     }
              })(i,speeds[i].value);
          } 

           delay = speeds[2].value;

           function createTable() {
               table = document.createElement('table');

               for(var y=0; y < height; y++) {
                   var row = table.insertRow(y);
                   for(var x=0; x < width; x++) {
                       var col = row.insertCell(x);
                   } 
               }  
               div.appendChild(table);
           }

           function clearTable() {
               for(var y=0; y < height; y++) {
                   var row = table.rows[y];
                   for(var x=0; x < width; x++) {
                       row.cells[x].className = '';
                   } 
               }  
           }

           function getRandomCellApple() {
               var cell = {};
               while(!cell.x || !cell.y || !cell.tableCell || cell.tableCell.className != '') {
                   cell.x = Math.floor(Math.random() * width);
                   cell.y = Math.floor(Math.random() * height);
                   cell.tableCell = table.rows[cell.y].cells[cell.x]; 
               }
              return cell;
           }

           function generateApple() {
               apple = getRandomCellApple();
               apple.tableCell.className = 'apple';
           } 

           function generateSnake() {
               snake = {};
               snake.heading = 'right';
               snake.segments = [{x: Math.floor(width/2), y: Math.floor(height/2)}]; 
               snake.segments[0].tableCell = table.rows[snake.segments[0].y].cells[snake.segments[0].x]
               snake.segments[0].tableCell.className = 'snake-segment'; 
               snake.segmentHeadIndex = 0;
           }

           function displayTime() {
               gameDuration = Math.floor((new Date().getTime() - startTime) / 1000);
               timeField.innerHTML = gameDuration + 's'; 
           }

           function cancelClick(e) {

                 if(window.event) {
                    window.event.returnValue = false;
                    window.event.cancelBubble = true;  
                 } 

                 if(e && e.preventDefault && e.stopPropagation) {
                    e.preventDefault();
                    e.stopPropagation(); 
                 }
           } 

           function startGame() {
                 inGame = true;
                 score = 0;
                 startTime = new Date().getTime();
                 //displayScore();
                 //displayTime();
                 clearTable();
                 generateSnake();
                 generateApple();
                 window.setTimeout(move, delay);
           }

           function move() {

                  var snakeHead = snake.segments[snake.segmentHeadIndex],
                      nextCell = {x: snakeHead.x, y: snakeHead.y};

                      switch(snake.heading) {
                          case 'left':
                          nextCell.x--; 
                          break;

                          case 'right':
                          nextCell.x++; 
                          break;

                          case 'down':
                          nextCell.y++; 
                          break;

                          case 'up':
                          nextCell.y--; 
                          break;
                      } 
                 
                 if(checkSegmentAgainstBoundsAndSelf(nextCell)) {
                    
                    nextCell.tableCell = table.rows[nextCell.y].cells[nextCell.x];  

                    if(checkSegmentAgainstApple(nextCell)) {

                      //score++;
                      //displayScore();
                      addSegmentToHead(nextCell);
                      generateApple(); 

                    } else {
                      movin(nextCell);                      
                    }                  
     
                    window.setTimeout(move, delay);
                 } else {
                   endGame();
                 }                  
           }   

           //add handler to the keydown events keys(down,up,right,left) ie. bind the keyboard
           document.onkeydown = function(e) {
                e = e || window.event;

                switch(e.keyCode) {

                     //press left
                     case 37:  
                     if(inGame && snake.heading != 'right') {
                        snake.heading = 'left';
                     }
                     break;

                     //press right
                     case 39:
                     if(inGame && snake.heading != 'left') {
                        snake.heading = 'right';
                     }
                     break;

                     case 38:
                     if(inGame && snake.heading != 'down') {
                        snake.heading = 'up';
                     }
                     break;

                     case 40:
                     if(inGame && snake.heading != 'up') {
                        snake.heading = 'down';
                     }
                     break;
                }//end switch

           }//end handler for keydown event.

           /* returns TRUE if segment at same cell as the apple. */ 
           function checkSegmentAgainstApple(segment) {
                if(segment.x == apple.x && segment.y == apple.y) {
                   return true; 
                }  
             return false;
           } 

           /* check the segment position against bounds and itself . retuns false for invalid. */
           function checkSegmentAgainstBoundsAndSelf(segment) {
                if(segment.x < 0 || segment.y < 0 || segment.x >= width || segment.y >= height) {
                    return false;
                }  
                
                for(var i=0,j=snake.segments.length;i<j;i++) {
                    if(segment.x == snake.segments[i].x && segment.y == snake.segments[i].y) {
                       return false; 
                    }
                } 
             return true;
           } 
           
           function grayOutBoard() {
              for(var i=0,j=snake.segments.length;i<j;i++) {
                      snake.segments[i].tableCell.className = 'dead';
              }
              if(apple) {
                 apple.tableCell.className = 'dead';
              }
           }

           function endGame() {
              inGame = false;
              grayOutBoard();
              //checkAndSetHighScore();
              //displayHighScore(); 
           }

           function movin(segment) {
              var newHeadIndex = snake.segmentHeadIndex;

              newHeadIndex--;
              if(newHeadIndex < 0) {
                  newHeadIndex = snake.segments.length - 1;   
              }

              snake.segments[newHeadIndex].tableCell.className = '';
              segment.tableCell.className = 'snake-segment';
              snake.segments[newHeadIndex] = segment;
              snake.segmentHeadIndex = newHeadIndex;

           }  

           function addSegmentToHead(segment) {

              var newSegments = new Array(snake.segments.length + 1);
              newSegments[0] = segment;
              /* copy over the remaining segments */    
              for(var i=0,j=snake.segments.length;i<j;i++) {
                      var k = i + snake.segmentHeadIndex;
                      if(k>=snake.segments.length) {k -= snake.segments.length;} 
                      newSegments[i+1] = snake.segments[k];   
              }
              
              snake.segments = newSegments;
              snake.segmentHeadIndex = 0;
              snake.segments[0].tableCell.className = 'snake-segment';
           } 

   }//end Snake

   window.onload = function() {
          new Snake('snake', 15, 15, 'score', 'time', 'high-score', 'reset-high-score', 'speed-');

   } 
   </script>
</head>
<body>
<div>
   <ul id="header">
       <li><span header-title>Start Game:</span> <a href="#" id="speed-slow">Slow</a> | <a href="#" id="speed-medium">Medium</a> | <a href="#" id="speed-fast">Fast</a></li>
   </ul>
</div> 
<div id="container">
        <div id="stats">
          <p id="score-p" class="stat"><span class="stat-title">Score: </span><span id="score"></span></p>
          <p id="time-p" class="stat"><span class="stat-title">Time: </span><span id="time"></span></p>
        </div>
          <div id="snake"></div>
          <p id="high-score-p">Your high score <span id="high-score"></span> <a href="#" id="reset-high-score">reset</a></p> 
   </div>
</div>
</body>
</html>

